# -*- coding: utf-8 -*-
from max.MADMax import MADMaxDB
from max.exceptions import ObjectNotFound
from max.exceptions import Unauthorized
from max.models import Activity
from max.rest.ResourceHandlers import JSONResourceEntity
from max.rest.ResourceHandlers import JSONResourceRoot
from max.rest.utils import flatten
from max.rest.utils import searchParams

from pyramid.httpexceptions import HTTPNoContent
from pyramid.httpexceptions import HTTPNotImplemented
from max.rest import endpoint
from max.security.permissions import view_comments, add_comment, delete_comment


@endpoint(route_name='user_comments', request_method='GET', permission=view_comments, requires_actor=True)
def getUserComments(user, request):
    """
        Return the all the comments generated by a user
    """
    mmdb = MADMaxDB(request.db)
    query = {
        'object.objectType': 'comment',
        'verb': 'comment',
        'actor.username': user.username
    }
    is_head = request.method == 'HEAD'
    comments = mmdb.activity.search(
        query,
        sort="_id",
        keep_private_fields=False,
        squash=['deletable', 'favorited', 'favorites', 'faavoritesCount'],
        flatten=1,
        count=is_head,
        **searchParams(request))

    handler = JSONResourceRoot(comments, stats=is_head)
    return handler.buildResponse()


@endpoint(route_name='activity_comments', request_method='GET', permission=view_comments, requires_actor=True)
def getActivityComments(activity, request):
    """
        /activities/{activity}/comments

        Return the comments for an activity.
    """
    replies = activity.get('replies', {})
    items = replies
    result = flatten(items, keep_private_fields=False)
    handler = JSONResourceRoot(result)
    return handler.buildResponse()


@endpoint(route_name='comments', request_method='GET', permission=view_comments, requires_actor=True)
def getGlobalComments(comments, request):
    """
    """
    mmdb = MADMaxDB(request.db)
    is_head = request.method == 'HEAD'
    activities = mmdb.activity.search({'verb': 'comment'}, flatten=1, count=is_head, **searchParams(request))
    handler = JSONResourceRoot(activities, stats=is_head)
    return handler.buildResponse()


@endpoint(route_name='context_comments', request_method='GET', permission=view_comments, requires_actor=True)
def getContextComments(context, request):
    """
    """
    mmdb = MADMaxDB(request.db)
    is_head = request.method == 'HEAD'

    query = {
        'verb': 'comment',
        'object.inReplyTo.contexts': {
            '$in': [context['hash']]
        }
    }

    comments = mmdb.activity.search(query, flatten=1, count=is_head, **searchParams(request))
    handler = JSONResourceRoot(comments, stats=is_head)
    return handler.buildResponse()


@endpoint(route_name='activity_comments', request_method='POST', permission=add_comment, requires_actor=True)
def addActivityComment(activity, request):
    """
        /activities/{activity}/comments

        Post a comment to an activity.
    """

    # Prepare rest parameters to be merged with post data
    rest_params = {
        'verb': 'comment',
        'object': {
            'inReplyTo': [{
                '_id': activity['_id'],
                'objectType': activity.object['objectType'],
                'contexts': []
            }]
        }
    }

    # Initialize a Activity object from the request
    newactivity = Activity()
    newactivity.fromRequest(request, rest_params=rest_params)

    refering_activity_contexts = activity.get('contexts', [])
    if len(refering_activity_contexts) > 0:
        context_hashes = [ctxt['hash'] for ctxt in refering_activity_contexts]
        newactivity['object']['inReplyTo'][0]['contexts'] = context_hashes

    code = 201
    newactivity_oid = newactivity.insert()
    newactivity['_id'] = newactivity_oid

    comment = dict(newactivity.object)
    comment['published'] = newactivity.published
    comment['actor'] = request.actor
    comment['id'] = newactivity._id
    del comment['inReplyTo']
    activity.addComment(comment)

    handler = JSONResourceEntity(newactivity.flatten(), status_code=code)
    return handler.buildResponse()


@endpoint(route_name='activity_comment', request_method='DELETE', permission=delete_comment)
def deleteActivityComment(activity, request):
    """
    """
    commentid = request.matchdict.get('comment', None)

    comment = activity.get_comment(commentid)
    if not comment:
        raise ObjectNotFound("There's no comment with id: %s" % commentid)

    # if found_activity.deletable or request.actor_username == comment['actor']['username']:
    #     found_activity.delete_comment(commentid)
    # else:
    #     raise Unauthorized("You're not allowed to delete this comment")

    return HTTPNoContent()


@endpoint(route_name='activity_comment', request_method='GET')
def getActivityComment(context, request):
    """
    """
    return HTTPNotImplemented()  # pragma: no cover


@endpoint(route_name='activity_comments', request_method='PUT')
def modifyActivityComments(context, request):
    """
    """
    return HTTPNotImplemented()  # pragma: no cover


@endpoint(route_name='comments', request_method='DELETE')
def deleteActivityComments(context, request):
    """
    """
    return HTTPNotImplemented()  # pragma: no cover
